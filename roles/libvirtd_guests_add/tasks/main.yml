---
- name: Copy base OS volume file to libvirtd host
  become: yes
  # We use 'get_url' since we're often operating on remote hosts and our upload
  # bandwidth would make this slower than using the official download servers
  ansible.builtin.get_url:
    dest: "{{ libvirt_pool_base_images_path }}/{{ libvirt_os_base_image_name }}"
    checksum: sha512:{{ libvirt_os_cloud_image_sha512sums_url }}
    group: libvirt-qemu
    mode: "0660"
    owner: libvirt-qemu
    timeout: 30
    url: "{{ libvirt_os_cloud_image_url }}"
  notify: Refresh list of volumes in base-images pool
- name: Flush handlers (ensure list of volumes is up to date)
  ansible.builtin.meta: flush_handlers
- name: List all system instances on libvirtd host
  become: yes
  ansible.builtin.command:
    cmd: virsh list --name --all
  register: libvirt_domain_list
  changed_when: false
- name: Prepare a libvirt guest
  include_tasks: create_instance.yml
  loop: "{{ libvirt_guest_definitions[guest_envname] | dict2items }}"
  loop_control:
    loop_var: instance_item
  vars:
    ddata: "{{ env_default_userdata[guest_envname] }}"
    edata: "{{ env_conn_admin[guest_envname] }}"
    eddata: "{{ env_depends_conn_admin[guest_envname] }}"
    idata: "{{ env_guest_userdata[guest_envname][instance_item.key] }}"
    role_write_files:
    - content: "{{ '%sudonp ALL=(ALL) NOPASSWD: ALL' | b64encode }}"
      encoding: b64
      path: /etc/sudoers.d/sudonp
      permissions: "0400"
    - content: "{{ lookup('file', '50unattended-upgrades') | b64encode }}"
      encoding: b64
      path: /etc/apt/apt.conf.d/50unattended-upgrades
    - content: "{{ lookup('template', 'conf-ufw.j2') | b64encode }}"
      encoding: b64
      path: /run/ci-files/conf-ufw
      permissions: "0755"
    - content: "{{ lookup('template', 'jail.local.j2') | b64encode }}"
      encoding: b64
      path: /etc/fail2ban/jail.local
    - content: "{{ lookup('template', 'interfaces-ipv6.j2') | b64encode }}"
      encoding: b64
      path: /etc/network/interfaces.d/60-ens2-ipv6
    - content: "{{ lookup('template', 'local-home.site.local.j2') | b64encode }}"
      encoding: b64
      path: /etc/apparmor.d/tunables/home.d/local-home.site.local
    - content: "{{ lookup('template', 'sshd_custom.conf.j2') | b64encode }}"
      encoding: b64
      path: /etc/ssh/sshd_config.d/sshd_custom.conf
    - content: "{{ lookup('template', 'sshd_jail.local.j2') | b64encode }}"
      encoding: b64
      path: /etc/fail2ban/jail.d/ssh.local
  when: instance_item.key not in libvirt_domain_list.stdout_lines
...
