global
	log /dev/log local0
	log /dev/log local1 notice
	chroot /var/lib/haproxy
	stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
	stats timeout 30s
	user haproxy
	group haproxy
	daemon

	# Default SSL material locations
	ca-base /etc/ssl/certs
	crt-base /etc/ssl/private

	# See: https://ssl-config.mozilla.org/#server=haproxy&server-version=2.0.3&config=intermediate
	ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
	ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
	ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
	log global
	mode http
	option httplog
	option dontlognull
	option http-server-close
	option redispatch
	retries 3
	timeout http-request 10s
	timeout queue 1m
	timeout connect 10s
	timeout client 1m
	timeout server 1m
	timeout http-keep-alive 10s
	timeout check 10s
	# maxconn 3000
	errorfile 400 /etc/haproxy/errors/400.http
	errorfile 403 /etc/haproxy/errors/403.http
	errorfile 408 /etc/haproxy/errors/408.http
	errorfile 500 /etc/haproxy/errors/500.http
	errorfile 502 /etc/haproxy/errors/502.http
	errorfile 503 /etc/haproxy/errors/503.http
	errorfile 504 /etc/haproxy/errors/504.http

# frontend httpv4
# 	bind :80
# 	option forwardfor except 127.0.0.0/8

# 	log-format "%{+Q}o %{-Q}ci %{-Q}[capture.req.hdr(0)] - [%trg] %r %ST %B %[capture.req.hdr(1)] %[capture.req.hdr(2)] %cp %ms %ft %b %s"
# 	capture request header Host len 64
# 	capture request header Referer len 256
# 	capture request header User-Agent len 512

# 	filter cache main
# 	filter compression

frontend imap
	bind 0.0.0.0:{{ imap_port }},[::]:{{ imap_port }}
	mode tcp
	option tcplog
	default_backend srv_imap

#frontend submission
#	bind 0.0.0.0:{{ submission_port }},[::]:{{ submission_port }}
#	mode tcp
#	option tcplog
#	default_backend srv_submission

backend srv_imap
	mode tcp
	balance leastconn
	option tcp-check
	tcp-check connect port {{ dovecot_health_check_port }}
	tcp-check send PING\n
	tcp-check expect string PONG\n

	{% for mailbox_server in groups['mailbox_servers'] -%}
	server imap{{ loop.index }} {{ mailbox_server }}:{{ proxied_imap_port }} send-proxy-v2 check
	{% endfor %}

#backend srv_submission
#	mode tcp
#	balance leastconn
#	option tcp-check
#	tcp-check connect port {{ dovecot_health_check_port }}
#	tcp-check send PING\n
#	tcp-check expect string PONG\n

#	{% for mailbox_server in groups['mailbox_servers'] -%}
#	server submission{{ loop.index }} {{ mailbox_server }}:{{ proxied_submission_port }} send-proxy-v2 check
#	{% endfor %}
