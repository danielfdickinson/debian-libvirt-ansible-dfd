#!/bin/bash

# Modified from https://wiki.libvirt.org/page/Networking#Forwarding_Incoming_Connections

# We only use IPv4 on internal (private) network.
GUEST_IP="{{ hostvars[item.name  + '.' + internal_domain]['ansible_facts']['ens3']['ipv4']['address'] }}"

if [ "${1}" = "{{ item.name }}" ]; then
	if [ "${2}" = "stopped" ] || [ "${2}" = "reconnect" ]; then
		/usr/sbin/iptables -D FORWARD -o {{ vbridge }} -p tcp -d $GUEST_IP --dport {{ item.guest_port }} -j ACCEPT
		/usr/sbin/iptables -t nat -D PREROUTING -p tcp --dport {{ item.host_port }} -j DNAT --to $GUEST_IP:{{ item.guest_port }}
	fi
	if [ "${2}" = "start" ] || [ "${2}" = "reconnect" ]; then
		/usr/sbin/iptables -I FORWARD -o {{ vbridge }} -p tcp -d $GUEST_IP --dport {{ item.guest_port }} -j ACCEPT
		/usr/sbin/iptables -t nat -I PREROUTING -p tcp --dport {{ item.host_port }} -j DNAT --to $GUEST_IP:{{ item.guest_port }}
	fi
fi
