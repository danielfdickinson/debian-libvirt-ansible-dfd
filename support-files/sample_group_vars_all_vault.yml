---
# partial / possibly out-of-date
vault_bare_metal_ansible_initial_become_password: ""
vault_bare_metal_ansible_initial_ssh_port: 22
vault_bare_metal_ansible_initial_ssh_user: debian
vault_default_mail_local_destinations:
- localhost
- localhost.localdomain
- "{{ ansible_facts['hostname'] }}.localdomain"
- localhost.{{ ansible_facts['domain'] }}
- localhost.{{ internal_domain }}
- "{{ internal_fqdn }}"
- "{{ ansible_facts['fqdn'] }}"
vault_env_conn_admin:
  bare_metal_env1:
    admin_base_homedir: &default_admin_base_homedir /local-home
    admin_gecos: &default_admin_gecos Admin
    admin_password: &default_admin_password a-hashed-password
    admin_ssh_key: &default_admin_ssh_key admin-ssh-public-key
    admin_ssh_key_userdata: &default_admin_ssh_key_initial userdata-admin-ssh-public-key
    admin_user: &default_admin_user admin
    ansible_become_password: &default_become_password password-for-a-hashed-passwd
    ansible_ssh_port: "{{ host_ansible_ssh_port | default(22) }}"
    ansible_ssh_user: *default_admin_user
    central_local_domain: &main_central_local_domain virtenv1
    central_local_email: &main_central_local_email admin@virtenv1
    external_rfc1618_domain: &main_external_rfc1618_domain example.com
    fallback_dns: &main_fallback_dns 192.168.1.1
    internal_domain: &main_internal_domain virtenv1
    internal_relay_port: &main_internal_relay_port 12345
    libvirt_client_ssh_key: libvirt-client-ssh-public-key
    libvirt_client_user: libvirt-client
    local_ipv6_cidr: "{{ host_local_ipv6_cidr }}"
    local_ipv6_gateway: "{{ host_local_ipv6_gateway }}"
    remote_admin_ip: &main_remote_admin_ip 192.168.1.0/24
    remote_monitoring_ips:
    v6natnet_ula: fdbc:8b5d:95d9::/48
  virtenv1:
    admin_base_homedir: *default_admin_base_homedir
    admin_gecos: *default_admin_gecos
    admin_password: *default_admin_password
    admin_ssh_key: *default_admin_ssh_key
    admin_ssh_key_userdata: *default_admin_ssh_key_initial
    admin_user: *default_admin_user
    ansible_become_password: *default_become_password
    ansible_ssh_port: "{{ host_ansible_ssh_port | default(22) }}"
    ansible_ssh_user: *default_admin_user
    central_local_domain: *main_central_local_domain
    central_local_email: *main_central_local_email
    external_rfc1618_domain: *main_external_rfc1618_domain
    fallback_dns: *main_fallback_dns
    guest_ansible_ssh_port: &default_guest_ssh_port 22
    internal_domain: *main_internal_domain
    internal_relay_port: *main_internal_relay_port
    local_ipv6_cidr: "{{ host_local_ipv6_cidr }}"
    local_ipv6_gateway: "{{ host_local_ipv6_gateway }}"
    remote_admin_ip: *main_remote_admin_ip
    remote_monitoring_ips:
    pool_os: default
    v4nat_addr: 192.168.123.1
    v4nat_net: 192.168.123.0
    v4nat_prefix: 24
    v6nat_addr: fdbc:8b5d:95d9::1
    v6nat_net: "fdbc:8b5d:95d9::"
    v6nat_prefix: 56
    v6natnet_ula: fdbc:8b5d:95d9::/48
    vbridge: "{{ host_vbridge['virtenv1'] }}"
vault_env_default_userdata:
  virtenv1:
    apt:
      preserve_sources_list: true
      http_proxy: "http://192.168.1.200:3142/"
    groups:
    - adm
    - sudo
    - sudonp
    - sys
    ntp_servers:
    - "{{ vault_env_conn_admin['virtenv1']['v4nat_addr'] }}"
    - "{{ vault_env_conn_admin['virtenv1']['v6nat_addr'] }}"
    packages:
    - molly-guard
    - powermgmt-base
    - python3-gi
    - ufw
    - unattended-upgrades
    runcmd_before:
    - [set, -xe]
    - [systemctl, reload, apparmor]
    runcmd_after:
    - [bash, /run/ci-files/conf-ufw]
    # - [systemctl, daemon-reload]
    - [systemctl, restart, networking]
    - [rm, -rf, /run/ci-files]
    users:
    - name: "{{ vault_env_conn_admin['virtenv1']['admin_user'] }}"
      gecos: "{{ vault_env_conn_admin['virtenv1']['admin_gecos'] }}"
      groups:
      - adm
      - sudo
      - sudonp
      homedir: "{{ vault_env_conn_admin['virtenv1']['admin_base_homedir'] }}/{{ vault_env_conn_admin['virtenv1']['admin_user'] }}"
      lock_passwd: true
      # plain_text_passwd: LetMeIn
      shell: /bin/bash
      ssh_authorized_keys:
      - no-agent-forwarding,no-port-forwarding {{ vault_env_conn_admin['virtenv1']['admin_ssh_key_userdata'] }}
    write_files:
    - content: "{{ '%sudonp ALL=(ALL) NOPASSWD: ALL' | b64encode }}"
      encoding: b64
      path: /etc/sudoers.d/sudonp
      permissions: "0400"
    - content: "{{ lookup('file', '50unattended-upgrades') | b64encode }}"
      encoding: b64
      path: /etc/apt/apt.conf.d/50unattended-upgrades
    - content: "{{ lookup('template', 'conf-ufw.j2') | b64encode }}"
      encoding: b64
      path: /run/ci-files/conf-ufw
      permissions: "0755"
    - content: "{{ lookup('template', 'jail.local.j2') | b64encode }}"
      encoding: b64
      path: /etc/fail2ban/jail.local
    - content: "{{ lookup('template', 'interfaces-ipv6.j2') | b64encode }}"
      encoding: b64
      path: /etc/network/interfaces.d/60-ens2-ipv6
    - content: "{{ lookup('template', 'local-home.site.local.j2') | b64encode }}"
      encoding: b64
      path: /etc/apparmor.d/tunables/home.d/local-home.site.local
    - content: "{{ lookup('template', 'sshd_custom.conf.j2') | b64encode }}"
      encoding: b64
      path: /etc/ssh/sshd_config.d/sshd_custom.conf
    - content: "{{ lookup('template', 'sshd_jail.local.j2') | b64encode }}"
      encoding: b64
      path: /etc/fail2ban/jail.d/ssh.local
vault_env_depends_conn_admin:
  bare_metal_local:
    mail_local_destinations: "{{ vault_default_mail_local_destinations }}"
    remote_ignore_ips: "{{ remote_admin_ip }}{% if remote_monitoring_ips is defined %} {{ remote_monitoring_ips }}{% endif %}"
  virtenv1:
    mail_local_destinations: "{{ vault_default_mail_local_destinations }}"
    remote_ignore_ips: "{{ remote_admin_ip }}{% if remote_monitoring_ips is defined %} {{ remote_monitoring_ips }}{% endif %}"
vault_env_guest_userdata:
  bastion1:
    fqdn: bastion1.example.com
    hostname: bastion1virtenv1
    packages:
    - fail2ban
    runcmd:
    - [systemctl, restart, fail2ban]
    users:
    - name: "{{ vault_bastion_user }}"
      homedir: "{{ admin_base_homedir }}/{{ vault_bastion_user }}"
      lock_passwd: true
      shell: /bin/bash
      ssh_authorized_keys:
      - "{{ vault_bastion_ssh_key }}"
vault_libvirt_guest_definitions:
- name: bastion1
  ansible_ssh_port: &airlock_ssh_port 667
  domain_forwards:
  - guest_port: *airlock_ssh_port
    host_port: *airlock_ssh_port
  envname: virtenv1
  libvirt_domain_name: bastion1virtenv1
  meta_data_change_id: virtenv1-01-00
  mac: 52:54:00:40:bf:09
  memory: 512
  v4addr: 192.168.123.100
  v4cidr: 192.168.123.100/24
  v4prefix: 24
  v6addr: fdbc:8b5d:95d9::100
  v6cidr: fdbc:8b5d:95d9::100/64
  v6prefix: 64
  vcpu: 1
  vol_name_os: bastion1virtenv1_os.qcow2
  vol_size_os: 8G
vault_public_cert_cert_file: /etc/ssl/certs/ssl-cert-snakeoil.pem
vault_public_cert_key_file: /etc/ssl/private/ssl-cert-snakeoil.key
vault_well_known_admin_aliases:
- "{{ admin_user }}"
# A list of well-known admin addresses (like abuse and and www)
...
