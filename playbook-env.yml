---
- hosts: bastions
  gather_facts: false
  pre_tasks:
  - name: Ensure given environment is valid
    ansible.builtin.assert:
      that:
      - envname in group_names
      quiet: true
      fail_msg: "{{ envname | quote }} is not a valid envname (environment)"

- hosts: bastions
  gather_facts: true
  any_errors_fatal: true
  roles:
  - packages_base
  - user_bastion_user_add
  - packages_ssh_proxy
  - fail2ban_ssh
  - packages_firmware

- hosts: all
  any_errors_fatal: true
  gather_facts: true
  roles:
  - user_admin_add_password

- hosts: edge_hosts
  roles:
  - fail2ban

- hosts: all:!libvirtd_hosts:!bastions
  any_errors_fatal: true
  roles:
  - packages_base
  - packages_firmware

- hosts: backup_clients_ovh
  roles:
  - backup_ovh

- hosts: cert_private_ssl_servers
  roles:
  - cert_private

- hosts: internal_mxes
  roles:
  - postfix_mx_internal

- hosts: mailbox_servers
  roles:
  - dovecot

- hosts: email_internal_senders:!internal_mxes
  roles:
  - postfix_sender_internal

- hosts: rproxy_external
  roles:
  - haproxy

- hosts: website_servers:rproxy_internal
  roles:
  - apache2_proxy_protocol
...
